<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoutPass | Command Hub V19</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5285E8">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --bg:#F0F5F4; --dark:#181818; --blue:#5285E8; --white:#fff; --sb-w:260px; }
        body { background:var(--bg); color:var(--dark); font-family:'Outfit',sans-serif; overflow-x:hidden; }
        .sidebar { position:fixed; top:0; left:0; height:100vh; width:var(--sb-w); background:var(--white); padding:25px; z-index:1000; }
        .main-content { margin-left:var(--sb-w); padding:30px; }
        .nav-link { padding:12px; border-radius:12px; margin-bottom:8px; cursor:pointer; color:#6c757d; font-weight:500; transition:0.2s; }
        .nav-link.active, .nav-link:hover { background:rgba(82,133,232,0.1); color:var(--blue); font-weight:600; }
        .stat-card { background:var(--white); border-radius:20px; padding:25px; box-shadow:0 4px 20px rgba(0,0,0,0.03); height:100%; transition:0.2s; }
        .stat-card:hover { transform:translateY(-3px); }
        .live-val { font-size:2rem; font-weight:800; line-height:1; }
        .admin-only { display:none; } /* Hidden by default */
        #qr-hidden, #debugBox { display:none; }
    </style>
</head>
<body>

<div id="qr-hidden"></div>

<div class="sidebar">
    <h3 class="fw-bold mb-4">Scout<span style="color:var(--blue)">Pass</span></h3>
    <div class="nav-link active" onclick="showSection('dashboard', this)"><i class="bi bi-grid-1x2-fill me-2"></i> War Room</div>
    <div class="nav-link" onclick="showSection('search', this)"><i class="bi bi-search me-2"></i> Search</div>
    <div class="nav-link" onclick="showSection('registration', this)"><i class="bi bi-person-vcard-fill me-2"></i> Registration</div>
    <div class="nav-link" onclick="showSection('events', this)"><i class="bi bi-calendar-check-fill me-2"></i> Events</div>
    <div class="nav-link admin-only" onclick="showSection('staff', this)"><i class="bi bi-people-fill me-2"></i> Staff</div>
    <div class="nav-link admin-only" onclick="showSection('settings', this)"><i class="bi bi-sliders me-2"></i> Settings</div>
    <div class="mt-auto pt-4 border-top">
        <div class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-right me-2"></i> Logout</div>
    </div>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h3 class="fw-bold mb-0">War Room</h3><small class="text-muted">Role: <span id="userRoleBadge" class="badge bg-secondary">Loading...</span></small></div>
    </div>

    <div id="sec-dashboard" class="section animate__animated animate__fadeIn">
        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="stat-card border-start border-primary border-4"><h6>Registered</h6><h1 class="card-number" id="statRegCount">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card border-start border-warning border-4"><h6>Total Scans</h6><h1 class="card-number" id="statTotalScans">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card border-start border-success border-4"><h6>Inside</h6><h1 class="card-number text-success" id="statInside">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card"><h6>Events</h6><h1 class="card-number text-primary" id="statEventsCount">0</h1></div></div>
        </div>
        <div class="row g-3" id="liveEventCards"><div class="col-12 text-center text-muted py-5">Initializing data stream...</div></div>
    </div>

    <div id="sec-search" class="section" style="display:none;">
        <div class="row justify-content-center"><div class="col-md-8"><div class="stat-card text-center">
            <h5 class="fw-bold mb-4">Find Scout</h5>
            <div class="input-group mb-3"><input type="text" id="searchInput" class="form-control" placeholder="Enter ID"><button class="btn btn-primary" onclick="performSearch()">Search</button></div>
            <div id="searchResult" style="display:none"><h3 class="fw-bold" id="resName">-</h3><div class="badge bg-dark mb-3" id="resID">-</div><button class="btn btn-outline-primary" onclick="downloadSingleID()">Download ID</button></div>
        </div></div></div>
    </div>

    <div id="sec-registration" class="section" style="display:none;">
        <div class="row">
            <div class="col-md-5"><div class="stat-card"><h5>Register</h5><textarea id="bulkText" class="form-control mb-3" rows="8" placeholder="ID, Name"></textarea><button class="btn btn-success w-100 mb-2" onclick="processRegistration(true)">Register & Print</button><button class="btn btn-dark w-100" onclick="processRegistration(false)">Register Only</button></div></div>
            <div class="col-md-7"><div class="stat-card"><h5>Database</h5><button class="btn btn-sm btn-outline-success mb-3" onclick="exportScoutsCSV()">Export CSV</button><div style="max-height:400px;overflow-y:auto"><table class="table table-hover small"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody id="regPreviewTable"><tr><td colspan="2">Load from Export</td></tr></tbody></table></div></div></div>
        </div>
    </div>

    <div id="sec-events" class="section" style="display:none;">
        <div class="row">
            <div class="col-md-4"><div class="stat-card"><h5>New Event</h5><input id="evtName" class="form-control mb-2" placeholder="Name"><select id="evtType" class="form-select mb-3"><option value="ACCESS">Gate</option><option value="ACTIVITY">Activity</option></select><button onclick="addNewEvent()" class="btn btn-primary w-100">Create</button></div></div>
            <div class="col-md-8"><div class="stat-card"><h5>Active Events</h5><div id="eventsListContainer"></div></div></div>
        </div>
    </div>

    <div id="sec-staff" class="section" style="display:none;">
        <div class="stat-card mb-4">
            <h5>Add Staff</h5>
            <div class="row g-2">
                <div class="col-md-3"><input id="stfEmail" class="form-control" placeholder="Email"></div>
                <div class="col-md-3"><input id="stfPass" class="form-control" placeholder="Password"></div>
                <div class="col-md-3"><select id="stfRole" class="form-select"><option value="scanner">Scanner</option><option value="moderator">Moderator</option><option value="admin">Admin</option></select></div>
                <div class="col-md-3"><button onclick="addStaffMember()" class="btn btn-success w-100">Add User</button></div>
            </div>
        </div>
        <div class="stat-card"><h5>Staff List</h5><table class="table"><thead><tr><th>Email</th><th>Role</th><th>Password</th><th>Action</th></tr></thead><tbody id="staffTableBody"></tbody></table></div>
    </div>

    <div id="sec-settings" class="section" style="display:none;">
        <div class="row">
            <div class="col-md-6"><div class="stat-card border-warning border-start border-4"><h5>Lock System</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="scannerLockSwitch" onchange="toggleScannerLock(this)"> <label>Lock All Scanners</label></div></div></div>
            <div class="col-md-6"><div class="stat-card border-danger border-start border-4"><h5>Danger Zone</h5><button onclick="initiateSystemReset()" class="btn btn-danger w-100 mt-2">Factory Reset</button></div></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { apiKey: "AIzaSyBZzwTD7gSTmsQhSvQYARZP_bUfKXW4Myg", authDomain: "scoutpak-6fed9.firebaseapp.com", databaseURL: "https://scoutpak-6fed9-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "scoutpak-6fed9", storageBucket: "scoutpak-6fed9.firebasestorage.app", messagingSenderId: "294082875833", appId: "1:294082875833:web:3460d6dd3d501139ba6668" };
    const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const secondaryApp = initializeApp(firebaseConfig, "Secondary"); const secondaryAuth = getAuth(secondaryApp);

    let CURRENT_ROLE = 'scanner';
    let STATE = { events: {}, stats: {} };

    // --- AUTH & INITIALIZATION FLOW (THE FIX) ---
    onAuthStateChanged(auth, async u => {
        if (!u) window.location.href = "index.html";
        else {
            const s = await get(ref(db, `users/${u.uid}`));
            if(s.exists()) {
                CURRENT_ROLE = s.val().role;
                document.getElementById('userRoleBadge').innerText = CURRENT_ROLE.toUpperCase();
                
                // 1. Set Permissions First
                if(CURRENT_ROLE === 'admin') {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block'); // Explicitly show
                } else {
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                }

                // 2. Start Data Stream ONLY after Role is confirmed
                startDataSync();
            }
        }
    });

    function startDataSync() {
        // Events Listener
        onValue(ref(db, 'events'), snap => {
            STATE.events = snap.val() || {};
            renderDashboard(); 
            renderEventsList(); // Now CURRENT_ROLE is guaranteed to be set
        });

        // Stats Listener
        onValue(ref(db, 'stats'), snap => {
            STATE.stats = snap.val() || {};
            document.getElementById('statRegCount').innerText = STATE.stats.total_registered || 0;
            document.getElementById('statTotalScans').innerText = STATE.stats.total_scans || 0;
            document.getElementById('statInside').innerText = STATE.stats.present_now || 0;
            renderDashboard(); 
        });

        // Staff Listener (Only for Admins)
        if(CURRENT_ROLE === 'admin') {
            onValue(ref(db, 'users'), s => {
                const tb = document.getElementById('staffTableBody'); tb.innerHTML='';
                if(s.exists()) Object.entries(s.val()).forEach(([uid, u]) => {
                    const del = `<button class="btn btn-sm btn-danger ms-2" onclick="remS('${uid}')"><i class="bi bi-trash"></i></button>`;
                    tb.innerHTML += `<tr><td>${u.email}</td><td><span class="badge bg-secondary">${u.role}</span></td><td><div class="input-group input-group-sm" style="max-width:150px"><input type="password" value="${u.password}" id="p-${uid}" class="form-control" readonly><button class="btn btn-outline-secondary" onclick="togP('${uid}')"><i class="bi bi-eye"></i></button></div></td><td>${del}</td></tr>`;
                });
            });
        }
    }

    // --- UI RENDERERS ---
    function renderDashboard() {
        const container = document.getElementById('liveEventCards'); container.innerHTML = '';
        const eventKeys = Object.keys(STATE.events);
        document.getElementById('statEventsCount').innerText = eventKeys.length;

        if (eventKeys.length === 0) { container.innerHTML = '<div class="col-12 text-center text-muted py-5">No Active Events</div>'; return; }

        const eventStats = STATE.stats.events || {};
        eventKeys.forEach(id => {
            const evt = STATE.events[id];
            let stat = eventStats[id]; // ID Match
            if (!stat) { const mKey = Object.keys(eventStats).find(k => k === evt.name || k.trim() === evt.name.trim()); if(mKey) stat = eventStats[mKey]; } // Name Match Fallback
            stat = stat || { in: 0, out: 0, completed: 0 };
            
            let html = evt.type === 'ACCESS' ? 
                `<div class="row text-center mt-3 g-0"><div class="col-4 border-end"><div class="live-val text-success">${stat.in||0}</div><small>IN</small></div><div class="col-4 border-end"><div class="live-val text-danger">${stat.out||0}</div><small>OUT</small></div><div class="col-4"><div class="live-val text-primary">${(stat.in||0)-(stat.out||0)}</div><small>NET</small></div></div>` : 
                `<div class="text-center mt-3"><div class="live-val text-info" style="font-size:2.5rem;">${stat.completed||0}</div><small>COMPLETED</small></div>`;

            container.innerHTML += `<div class="col-md-4"><div class="stat-card border-top border-4 border-primary shadow-sm"><div class="d-flex justify-content-between"><h5 class="fw-bold mb-0 text-truncate">${evt.name}</h5><span class="badge bg-light text-dark border">${evt.type}</span></div>${html}</div></div>`;
        });
    }

    function renderEventsList() {
        const list = document.getElementById('eventsListContainer'); list.innerHTML = '';
        Object.entries(STATE.events).forEach(([id, evt]) => {
            const delBtn = (CURRENT_ROLE === 'admin') ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${id}')"><i class="bi bi-trash"></i></button>` : '';
            list.innerHTML += `<div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-2"><div><b>${evt.name}</b> <small class="text-muted">${evt.type}</small></div>${delBtn}</div>`;
        });
    }

    // --- ACTIONS ---
    window.addNewEvent = async () => {
        const name = document.getElementById('evtName').value.trim(); const type = document.getElementById('evtType').value;
        if (!name) return Swal.fire('Error', 'Name required', 'error');
        await push(ref(db, 'events'), { name, type, buttons: type==='ACCESS'?['IN','OUT']:['SCAN'], active: true, createdAt: Date.now() });
        Swal.fire('Success', 'Created', 'success'); document.getElementById('evtName').value = '';
    };

    window.deleteEvent = async (id) => { if(CURRENT_ROLE==='admin' && confirm('Delete?')) await remove(ref(db, `events/${id}`)); };

    window.addStaffMember = async () => {
        const e = document.getElementById('stfEmail').value; const p = document.getElementById('stfPass').value; const r = document.getElementById('stfRole').value;
        if(!e || !p) return Swal.fire('Warning','Fill fields','warning');
        try {
            Swal.fire({title:'Creating...', didOpen:()=>Swal.showLoading()});
            const u = await createUserWithEmailAndPassword(secondaryAuth, e, p);
            await set(ref(db, `users/${u.user.uid}`), {email:e, role:r, password:p});
            await signOut(secondaryAuth);
            Swal.fire('Success','User Created','success');
            document.getElementById('stfEmail').value=''; document.getElementById('stfPass').value='';
        } catch(err) { Swal.fire('Error',err.message,'error'); }
    };

    window.processRegistration = async (print) => {
        const txt = document.getElementById('bulkText').value; const lines = txt.split('\n'); const up = {}; let c=0; const list=[];
        lines.forEach(l => { const [id, n] = l.split(','); if(id&&n) { up[`scouts/${id.trim().replace(/[.#$/[\]]/g,'_')}`] = {id:id.trim(), name:n.trim()}; list.push({id:id.trim(), name:n.trim()}); c++; } });
        if(c>0) { up['stats/total_registered'] = increment(c); await update(ref(db, up)); if(print) generatePDF(list); Swal.fire('Done', `Added ${c}`, 'success'); document.getElementById('bulkText').value=''; }
    };

    window.generatePDF = async (list) => {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('p','mm','a4'); const qr = document.getElementById('qr-hidden'); const w=47.5, h=69, mx=10, my=10;
        for(let i=0; i<list.length; i++) {
            const s=list[i]; if(i>0&&i%16===0)doc.addPage(); const col=i%4; const row=Math.floor((i%16)/4); const x=mx+(col*w); const y=my+(row*h);
            doc.rect(x+1,y+1,w-2,h-2); doc.setFontSize(9); doc.text("SCOUTPASS",x+w/2,y+8,{align:'center'});
            qr.innerHTML=''; new QRCode(qr,{text:s.id,width:120,height:120}); await new Promise(r=>setTimeout(r,50));
            doc.addImage(qr.querySelector('canvas').toDataURL('image/png'),'PNG',x+(w-30)/2,y+15,30,30);
            doc.setFontSize(11); doc.text(s.id,x+w/2,y+50,{align:'center'}); doc.setFontSize(8); doc.text(doc.splitTextToSize(s.name,w-6),x+w/2,y+57,{align:'center'});
        } doc.save('ids.pdf');
    };

    // UTILS
    window.togP=(id)=>{const x=document.getElementById('p-'+id);x.type=x.type==='password'?'text':'password'};
    window.remS=async(uid)=>{if(CURRENT_ROLE==='admin'&&confirm('Delete?'))await remove(ref(db,`users/${uid}`))};
    window.initiateSystemReset=async()=>{if(prompt("Master Key")==="200431504082"&&confirm("Sure?"))await update(ref(db),{scouts:null,logs:null,stats:null});};
    window.performSearch=async()=>{const id=document.getElementById('searchInput').value.trim(); const s=await get(ref(db,`scouts/${id.replace(/[.#$/[\]]/g,'_')}`)); if(s.exists()){document.getElementById('resName').innerText=s.val().name;document.getElementById('resID').innerText=s.val().id;document.getElementById('searchResult').style.display='block';window.foundScout=s.val();}else Swal.fire('Not Found','','error');};
    window.downloadSingleID=()=>{if(window.foundScout)generatePDF([window.foundScout])};
    window.toggleScannerLock=(el)=>set(ref(db,'system/scannerLock'),el.checked);
    window.exportScoutsCSV=async()=>{const s=await get(ref(db,'scouts'));if(s.exists()){let c="ID,Name\n";Object.values(s.val()).forEach(v=>c+=`${v.id},${v.name}\n`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c]));a.download="Scouts.csv";a.click();}};
    window.importCSVFile=(i)=>{Papa.parse(i.files[0],{complete:(r)=>{let t="";r.data.forEach(d=>{if(d.length>=2)t+=`${d[0]},${d[1]}\n`});document.getElementById('bulkText').value=t;}})};
    window.showSection=(id,el)=>{document.querySelectorAll('.section').forEach(s=>s.style.display='none');document.getElementById('sec-'+id).style.display='block';document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));el.classList.add('active');};
    window.logout=()=>signOut(auth).then(()=>window.location.href="index.html");

    window.addNewEvent = addNewEvent; window.deleteEvent = deleteEvent; window.processRegistration = processRegistration;
    window.addStaffMember = addStaffMember; window.performSearch = performSearch; window.downloadSingleID = downloadSingleID;
    window.toggleScannerLock = toggleScannerLock; window.initiateSystemReset = initiateSystemReset;
    window.exportScoutsCSV = exportScoutsCSV; window.importCSVFile = importCSVFile; window.togP = togP; window.remS = remS;
</script>
</body>
</html>
