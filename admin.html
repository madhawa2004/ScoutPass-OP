<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScoutPass | Command Hub V15.1</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5285E8">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        :root { --bg-light: #F0F5F4; --text-dark: #181818; --primary-blue: #5285E8; --accent-lime: #B8FB4C; --white: #ffffff; --sidebar-width: 260px; }
        body { background-color: var(--bg-light); color: var(--text-dark); font-family: 'Outfit', sans-serif; overflow-x: hidden; }
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: var(--sidebar-width); background: var(--white); border-right: 1px solid rgba(0,0,0,0.05); padding: 25px; z-index: 1000; }
        .brand-logo { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); margin-bottom: 40px; }
        .nav-link { color: #6c757d; font-weight: 500; padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: rgba(82, 133, 232, 0.1); color: var(--primary-blue); font-weight: 600; }
        .main-content { margin-left: var(--sidebar-width); padding: 30px; }
        .stat-card { background: var(--white); border-radius: 20px; padding: 25px; border: 1px solid rgba(0,0,0,0.02); box-shadow: 0 4px 20px rgba(0,0,0,0.03); height: 100%; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .card-number { font-size: 2.5rem; font-weight: 700; color: var(--text-dark); margin-bottom: 0; }
        .btn-lime { background: var(--accent-lime); color: var(--text-dark); border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; transition: 0.3s; }
        .btn-blue { background: var(--primary-blue); color: var(--white); border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; transition: 0.3s; }
        .btn-danger-custom { background: #ff4d4d; color: white; border:none; padding: 10px 20px; border-radius: 12px; font-weight: 600; }
        .live-stat-box { font-size: 0.7rem; font-weight: 700; color: #adb5bd; letter-spacing: 1px; margin-top: 5px; }
        .live-stat-val { font-size: 1.8rem; font-weight: 800; line-height: 1; transition: color 0.3s; }
        .admin-only { display: block; }
        #qr-hidden { display: none; }
        .search-result-card { text-align: center; display: none; background: #f8f9fa; border-radius: 15px; padding: 20px; margin-top: 20px; border: 2px dashed #dee2e6; }
    </style>
</head>
<body>

<div id="qr-hidden"></div>

<div class="sidebar">
    <div class="brand-logo"><i class="bi bi-shield-lock-fill text-primary me-2"></i>Scout<span style="color:var(--primary-blue)">Pass</span></div>
    <div class="nav flex-column">
        <div class="nav-link active" onclick="showSection('dashboard', this)"><i class="bi bi-grid-1x2-fill"></i> War Room</div>
        <div class="nav-link" onclick="showSection('search', this)"><i class="bi bi-search"></i> Scout Search</div>
        <div class="nav-link" onclick="showSection('registration', this)"><i class="bi bi-person-vcard-fill"></i> Registration</div>
        <div class="nav-link" onclick="showSection('events', this)"><i class="bi bi-calendar-check-fill"></i> Events</div>
        <div class="nav-link admin-only" onclick="showSection('staff', this)"><i class="bi bi-people-fill"></i> Staff Manager</div>
        <div class="nav-link admin-only" onclick="showSection('settings', this)"><i class="bi bi-sliders"></i> Settings</div>
        <div class="mt-auto pt-4 border-top">
            <div class="nav-link text-danger" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</div>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div><h3 class="fw-bold mb-0" id="pageTitle">War Room</h3><small class="text-muted">Role: <span id="userRoleBadge" class="badge bg-secondary">...</span></small></div>
    </div>

    <div id="sec-dashboard" class="section animate__animated animate__fadeIn">
        <div class="row g-4 mb-4">
            <div class="col-md-3"><div class="stat-card border-start border-primary border-4"><h6>Registered</h6><h1 class="card-number" id="statRegCount">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card border-start border-warning border-4"><h6>Total Scans</h6><h1 class="card-number" id="statTotalScans">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card border-start border-success border-4"><h6>Inside Camp</h6><h1 class="card-number text-success" id="statInside">0</h1></div></div>
            <div class="col-md-3"><div class="stat-card"><h6>Events</h6><h1 class="card-number text-primary" id="statEventsCount">0</h1></div></div>
        </div>
        <h5 class="fw-bold text-muted mb-3">Live Activity Feed</h5>
        <div class="row g-3" id="liveEventCards"><div class="col-12 text-center text-muted py-5">Connecting to live feed...</div></div>
    </div>

    <div id="sec-search" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="stat-card text-center">
                    <h5 class="fw-bold mb-4">Find a Scout</h5>
                    <div class="input-group mb-3">
                        <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Enter ID (e.g., KG001)">
                        <button class="btn btn-blue" onclick="performSearch()">Search</button>
                    </div>
                    <div id="searchResult" class="search-result-card">
                        <h3 class="fw-bold" id="resName">-</h3>
                        <div class="badge bg-dark fs-6 mb-3" id="resID">-</div>
                        <button class="btn btn-outline-primary mt-1" onclick="downloadSingleID()">Download ID Card</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sec-registration" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-5">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">Add Scouts</h5>
                    <div class="alert alert-light border small">Format: <b>ID, Name</b><br>Ex: <code>KG001, Kamal Perera</code></div>
                    <textarea id="bulkText" class="form-control mb-3" rows="8"></textarea>
                    <div class="d-grid gap-2">
                        <button class="btn btn-lime" onclick="processRegistration(true)">Register & Print IDs</button>
                        <button class="btn btn-dark" onclick="processRegistration(false)">Register Only</button>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <div class="stat-card">
                    <div class="d-flex justify-content-between mb-3"><h5 class="fw-bold">Database</h5><button class="btn btn-sm btn-outline-success" onclick="exportScoutsCSV()">Export CSV</button></div>
                    <div class="table-responsive" style="max-height:400px;overflow-y:auto"><table class="table table-hover small"><thead><tr><th>ID</th><th>Name</th></tr></thead><tbody id="regPreviewTable"><tr><td colspan="2" class="text-center">Load from Export</td></tr></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <div id="sec-events" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <h5 class="fw-bold mb-3">Create Event</h5>
                    <input type="text" id="evtName" class="form-control mb-2" placeholder="Name (e.g. Lunch)">
                    <select id="evtType" class="form-select mb-2"><option value="ACCESS">Gate (IN/OUT)</option><option value="ACTIVITY">Activity (Completion)</option></select>
                    <input type="text" id="evtBtns" class="form-control mb-3" placeholder="Buttons (Optional)">
                    <button onclick="addNewEvent()" class="btn btn-blue w-100">Add Event</button>
                </div>
            </div>
            <div class="col-md-8"><div class="stat-card"><h5 class="fw-bold mb-3">Active Events</h5><div id="eventsListContainer"></div></div></div>
        </div>
    </div>

    <div id="sec-staff" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="stat-card mb-4">
            <h5 class="fw-bold">Add Staff</h5>
            <div class="row g-2 mt-2">
                <div class="col-md-3"><input type="email" id="stfEmail" class="form-control" placeholder="Email"></div>
                <div class="col-md-3"><input type="text" id="stfPass" class="form-control" placeholder="Password (6+ chars)"></div>
                <div class="col-md-3">
                    <select id="stfRole" class="form-select">
                        <option value="scanner">Scanner</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="col-md-3"><button onclick="addStaffMember()" class="btn btn-lime w-100">Create</button></div>
            </div>
        </div>
        <div class="stat-card"><h5 class="fw-bold">Staff List</h5><table class="table table-custom"><thead><tr><th>Email</th><th>Role</th><th>Password</th><th>Action</th></tr></thead><tbody id="staffTableBody"></tbody></table></div>
    </div>

    <div id="sec-settings" class="section animate__animated animate__fadeIn" style="display:none;">
        <div class="row">
            <div class="col-md-6"><div class="stat-card border-warning border-start border-4"><h5>Scanner Lock</h5><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="scannerLockSwitch" onchange="toggleScannerLock(this)"> <label>Lock All Apps</label></div></div></div>
            <div class="col-md-6"><div class="stat-card border-danger border-start border-4"><h5 class="text-danger">System Reset</h5><button onclick="initiateSystemReset()" class="btn btn-danger-custom w-100 mt-2">Reset Data</button></div></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, get, update, push, remove, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // CONFIG
    const firebaseConfig = { apiKey: "AIzaSyBZzwTD7gSTmsQhSvQYARZP_bUfKXW4Myg", authDomain: "scoutpak-6fed9.firebaseapp.com", databaseURL: "https://scoutpak-6fed9-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "scoutpak-6fed9", storageBucket: "scoutpak-6fed9.firebasestorage.app", messagingSenderId: "294082875833", appId: "1:294082875833:web:3460d6dd3d501139ba6668" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const secondaryApp = initializeApp(firebaseConfig, "Secondary");
    const secondaryAuth = getAuth(secondaryApp);

    let CURRENT_ROLE = 'scanner';
    let STORE = { events: {}, stats: {} }; // Reactive State

    // AUTH
    onAuthStateChanged(auth, async u => {
        if (!u) window.location.href = "index.html";
        else {
            const s = await get(ref(db, `users/${u.uid}`));
            if(s.exists()) {
                CURRENT_ROLE = s.val().role;
                document.getElementById('userRoleBadge').innerText = CURRENT_ROLE.toUpperCase();
                if(CURRENT_ROLE!=='admin') document.querySelectorAll('.admin-only').forEach(e=>e.style.display='none');
            }
        }
    });

    // =========================================================
    // ðŸš€ THE REACTIVE ENGINE (FIXED)
    // =========================================================
    
    // 1. Fetch Events
    onValue(ref(db, 'events'), snap => {
        STORE.events = snap.val() || {};
        renderDashboard(); // Re-render when events change
        renderEventsList();
    });

    // 2. Fetch Stats (THIS WAS THE MISSING PART)
    onValue(ref(db, 'stats'), snap => {
        STORE.stats = snap.val() || {};
        
        // Update Global Counters
        document.getElementById('statRegCount').innerText = STORE.stats.total_registered || 0;
        document.getElementById('statTotalScans').innerText = STORE.stats.total_scans || 0;
        document.getElementById('statInside').innerText = STORE.stats.present_now || 0;

        // Force Re-render of Dashboard Cards with new numbers
        renderDashboard(); 
    });

    function renderDashboard() {
        const container = document.getElementById('liveEventCards');
        container.innerHTML = '';
        
        const eventKeys = Object.keys(STORE.events);
        document.getElementById('statEventsCount').innerText = eventKeys.length;

        if (eventKeys.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">No Active Events</div>';
            return;
        }

        // Access Stats safely using Event Name
        const eventStats = STORE.stats.events || {};

        eventKeys.forEach(id => {
            const evt = STORE.events[id];
            // Access stats using the event NAME (matching how scanner writes)
            const stat = eventStats[evt.name] || { in: 0, out: 0, completed: 0 };
            
            let html = '';
            if(evt.type === 'ACCESS') {
                const inC = parseInt(stat.in) || 0;
                const outC = parseInt(stat.out) || 0;
                const netC = inC - outC;
                
                html = `
                <div class="row text-center mt-3 g-0">
                    <div class="col-4 border-end"><div class="live-stat-val text-success">${inC}</div><div class="live-stat-box">IN</div></div>
                    <div class="col-4 border-end"><div class="live-stat-val text-danger">${outC}</div><div class="live-stat-box">OUT</div></div>
                    <div class="col-4"><div class="live-stat-val text-primary">${netC}</div><div class="live-stat-box">NET</div></div>
                </div>`;
            } else {
                html = `
                <div class="text-center mt-3">
                    <div class="live-stat-val text-info" style="font-size:2.5rem;">${stat.completed || 0}</div>
                    <div class="live-stat-box">COMPLETED</div>
                </div>`;
            }

            container.innerHTML += `
            <div class="col-md-4">
                <div class="stat-card p-4 border-top border-4 border-primary shadow-sm h-100">
                    <div class="d-flex justify-content-between">
                        <h5 class="fw-bold mb-0 text-truncate">${evt.name}</h5>
                        <span class="badge bg-light text-dark border">${evt.type}</span>
                    </div>
                    ${html}
                </div>
            </div>`;
        });
    }

    function renderEventsList() {
        const list = document.getElementById('eventsListContainer');
        list.innerHTML = '';
        Object.entries(STORE.events).forEach(([id, evt]) => {
            const delBtn = CURRENT_ROLE === 'admin' ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${id}')"><i class="bi bi-trash"></i></button>` : '';
            list.innerHTML += `<div class="d-flex justify-content-between align-items-center bg-light p-3 rounded mb-2"><div><b>${evt.name}</b> <small class="text-muted">${evt.type}</small></div>${delBtn}</div>`;
        });
    }

    // =========================================================
    // ACTIONS
    // =========================================================
    window.addNewEvent = async () => {
        const name = document.getElementById('evtName').value.trim();
        const type = document.getElementById('evtType').value;
        if (!name) return Swal.fire('Error', 'Name required', 'error');
        
        let buttons = type === 'ACCESS' ? ['IN', 'OUT'] : ['SCAN'];
        await push(ref(db, 'events'), { name, type, buttons, active: true, createdAt: Date.now() });
        Swal.fire('Success', 'Event Created', 'success');
        document.getElementById('evtName').value = '';
    };

    window.deleteEvent = async (id) => {
        if(CURRENT_ROLE !== 'admin') return Swal.fire('Denied', 'Admin Only', 'error');
        if(confirm('Delete?')) await remove(ref(db, `events/${id}`));
    };

    window.processRegistration = async (print) => {
        const txt = document.getElementById('bulkText').value;
        const lines = txt.split('\n');
        const up = {}; let c = 0;
        const list = [];

        lines.forEach(l => {
            const [id, n] = l.split(',');
            if(id && n) {
                up[`scouts/${id.trim().replace(/[.#$/[\]]/g, '_')}`] = {id:id.trim(), name:n.trim()};
                list.push({id:id.trim(), name:n.trim()});
                c++;
            }
        });

        if(c>0) {
            up['stats/total_registered'] = increment(c);
            await update(ref(db), up);
            if(print) generatePDF(list);
            Swal.fire('Done', `Added ${c}`, 'success');
            document.getElementById('bulkText').value='';
        }
    };

    window.generatePDF = async (list) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p','mm','a4');
        const qr = document.getElementById('qr-hidden');
        const w=47.5, h=69, mx=10, my=10;

        for(let i=0; i<list.length; i++) {
            const s = list[i];
            if(i>0 && i%16===0) doc.addPage();
            const col = i%4; const row = Math.floor((i%16)/4);
            const x = mx + (col*w); const y = my + (row*h);

            doc.rect(x+1, y+1, w-2, h-2);
            doc.setFontSize(9); doc.text("SCOUTPASS", x+w/2, y+8, {align:'center'});
            
            qr.innerHTML=''; new QRCode(qr, {text:s.id, width:120, height:120});
            await new Promise(r=>setTimeout(r,50));
            const img = qr.querySelector('canvas').toDataURL('image/png');
            doc.addImage(img, 'PNG', x+(w-30)/2, y+15, 30, 30);
            
            doc.setFontSize(11); doc.text(s.id, x+w/2, y+50, {align:'center'});
            doc.setFontSize(8); doc.text(doc.splitTextToSize(s.name, w-6), x+w/2, y+57, {align:'center'});
        }
        doc.save('ids.pdf');
    };

    // UTILS
    window.addStaffMember = async () => {
        const e = document.getElementById('stfEmail').value;
        const p = document.getElementById('stfPass').value;
        const r = document.getElementById('stfRole').value;
        try {
            const u = await createUserWithEmailAndPassword(secAuth, e, p);
            await set(ref(db, `users/${u.user.uid}`), {email:e, role:r, password:p});
            await signOut(secAuth);
            Swal.fire('Created','','success');
        } catch(e){Swal.fire('Error',e.message,'error');}
    };

    onValue(ref(db, 'users'), s => {
        const tb = document.getElementById('staffTableBody'); tb.innerHTML='';
        if(s.exists()) Object.entries(s.val()).forEach(([uid, u]) => {
            const del = CURRENT_ROLE==='admin' ? `<button class="btn btn-sm btn-danger" onclick="remS('${uid}')">Del</button>`:'';
            tb.innerHTML += `<tr><td>${u.email}</td><td>${u.role}</td><td><input type="password" value="${u.password}" id="p-${uid}" readonly style="width:80px;border:none"><i class="bi bi-eye ms-2" onclick="togP('${uid}')"></i></td><td>${del}</td></tr>`;
        });
    });

    window.togP=(id)=>{const x=document.getElementById('p-'+id);x.type=x.type==='password'?'text':'password'};
    window.remS=async(uid)=>{if(CURRENT_ROLE==='admin'&&confirm('Delete?'))await remove(ref(db,`users/${uid}`))};
    
    window.initiateSystemReset=async()=>{
        const {value:c}=await Swal.fire({title:'Master Key',input:'password'});
        if(c==='200431504082'){
            if((await Swal.fire({title:'Sure?',icon:'warning',showCancelButton:true})).isConfirmed){
                await update(ref(db),{scouts:null,logs:null,stats:null}); Swal.fire('Done','','success');
            }
        }
    };

    window.performSearch=async()=>{
        const id=document.getElementById('searchInput').value.trim();
        const s=await get(ref(db,`scouts/${id.replace(/[.#$/[\]]/g,'_')}`));
        if(s.exists()){
            document.getElementById('resName').innerText=s.val().name;
            document.getElementById('resID').innerText=s.val().id;
            document.getElementById('searchResult').style.display='block';
            window.foundScout=s.val();
        } else Swal.fire('Not Found','','error');
    };
    window.downloadSingleID=()=>{if(window.foundScout)generatePDF([window.foundScout])};

    window.toggleScannerLock=(el)=>set(ref(db,'system/scannerLock'),el.checked);
    window.exportScoutsCSV=async()=>{const s=await get(ref(db,'scouts'));if(s.exists()){let c="ID,Name\n";Object.values(s.val()).forEach(v=>c+=`${v.id},${v.name}\n`);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c]));a.download="Scouts.csv";a.click();}};
    window.importCSVFile=(i)=>{Papa.parse(i.files[0],{complete:(r)=>{let t="";r.data.forEach(d=>{if(d.length>=2)t+=`${d[0]},${d[1]}\n`});document.getElementById('bulkText').value=t;}})};

    window.showSection=(id,el)=>{document.querySelectorAll('.section').forEach(s=>s.style.display='none');document.getElementById('sec-'+id).style.display='block';document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));el.classList.add('active');};
    window.logout=()=>signOut(auth).then(()=>window.location.href="index.html");

    // ATTACH
    window.addNewEvent = addNewEvent; window.deleteEvent = deleteEvent;
    window.processRegistration = processRegistration; window.addStaffMember = addStaffMember;
    window.performSearch = performSearch; window.downloadSingleID = downloadSingleID;
    window.toggleScannerLock = toggleScannerLock; window.initiateSystemReset = initiateSystemReset;
    window.exportScoutsCSV = exportScoutsCSV; window.importCSVFile = importCSVFile;
    window.togP = toggleP; window.remS = remS;
</script>
</body>
</html>
